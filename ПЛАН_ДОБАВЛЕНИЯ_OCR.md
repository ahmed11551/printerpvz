# План добавления OCR как резервного метода

## Идея

Добавить OCR (распознавание текста с экрана) как **резервный метод** на случай, если DOM-метод не найдет номер ячейки.

## Варианты реализации

### Вариант 1: OCR как резервный метод (рекомендуется)

**Логика:**
1. Сначала пытаемся найти номер ячейки через DOM (быстро, точно)
2. Если не найдено → используем OCR (медленнее, но может найти)
3. Печатаем только один раз (избегаем дубликатов)

**Преимущества:**
- ✅ Максимальная надежность (два метода)
- ✅ Быстрота (DOM приоритетен)
- ✅ Резерв на случай изменений в структуре сайта
- ✅ Не мешает основному методу

**Недостатки:**
- ⚠️ Дополнительные зависимости
- ⚠️ Больше размер расширения
- ⚠️ Немного сложнее код

### Вариант 2: Выбор метода пользователем

**Логика:**
- Пользователь может выбрать: "Только DOM", "Только OCR", "DOM + OCR (резерв)"

**Преимущества:**
- ✅ Гибкость для пользователя
- ✅ Можно отключить OCR если не нужен

**Недостатки:**
- ⚠️ Сложнее интерфейс
- ⚠️ Пользователю нужно выбирать

### Вариант 3: Только OCR для определенных случаев

**Логика:**
- OCR используется только если DOM не нашел номер после N попыток
- Или для определенных элементов страницы

**Преимущества:**
- ✅ Минимальное влияние на производительность
- ✅ Только когда действительно нужно

## Рекомендуемая реализация (Вариант 1)

### Технологии для OCR:

**Вариант A: Tesseract.js (в браузере)**
- Библиотека: `tesseract.js`
- Плюсы: Работает в браузере, не требует сервера
- Минусы: Большой размер (~10MB), медленнее

**Вариант B: Canvas API + Tesseract.js**
- Захватываем область экрана через Canvas
- Распознаем через Tesseract.js
- Плюсы: Можно выбрать область
- Минусы: Нужно определить область сканирования

**Вариант C: Серверный OCR (на Python сервере)**
- Захват экрана через расширение
- Отправка на сервер
- OCR на сервере (Tesseract OCR, EasyOCR)
- Плюсы: Мощнее, можно на GPU
- Минусы: Сложнее, требует передачи данных

### Рекомендация: Tesseract.js (в браузере)

**Причины:**
1. Не требует изменений в сервере
2. Работает полностью в браузере
3. Достаточно для распознавания номеров ячеек
4. Можно использовать только при необходимости

## План реализации

### Шаг 1: Добавить Tesseract.js

```javascript
// В manifest.json добавить:
"web_accessible_resources": [{
  "resources": ["tesseract-worker.js"],
  "matches": ["<all_urls>"]
}]

// В content.js:
import Tesseract from 'tesseract.js';
```

### Шаг 2: Функция OCR распознавания

```javascript
async function recognizeCellNumberWithOCR(element) {
    try {
        // Захватываем изображение элемента
        const canvas = await html2canvas(element);
        
        // Распознаем текст
        const { data: { text } } = await Tesseract.recognize(
            canvas,
            'eng+rus',  // Английский и русский
            {
                logger: m => console.log(m)
            }
        );
        
        // Ищем номер ячейки в распознанном тексте
        return findCellNumber(text, platform);
    } catch (error) {
        console.error('OCR error:', error);
        return null;
    }
}
```

### Шаг 3: Интеграция в основной поиск

```javascript
async function searchCellInDOM() {
    // 1. Сначала DOM-метод (быстро)
    let cellNumber = searchCellInDOMSync();
    if (cellNumber) {
        return cellNumber;
    }
    
    // 2. Если не нашли → OCR (медленнее, но надежнее)
    const elements = document.querySelectorAll('*[class*="cell"], *[id*="cell"]');
    for (const element of elements) {
        cellNumber = await recognizeCellNumberWithOCR(element);
        if (cellNumber) {
            return cellNumber;
        }
    }
    
    return null;
}
```

### Шаг 4: Оптимизация

- Кэширование результатов OCR (чтобы не распознавать одно и то же дважды)
- Ограничение области сканирования (только видимые элементы)
- Таймаут для OCR (чтобы не ждать слишком долго)

## Зависимости

```json
// В manifest.json или через npm:
"tesseract.js": "^5.0.0"
// Или
"html2canvas": "^1.4.1"  // Для захвата элементов
```

## Настройки

Добавить в popup расширения:
- ☑ Использовать OCR как резервный метод
- ☐ Использовать только DOM-метод
- ☐ Использовать только OCR

## Оценка влияния

### Размер расширения:
- Без OCR: ~500KB
- С OCR (Tesseract.js): ~10-15MB (увеличится значительно)

### Производительность:
- DOM-метод: ~10-50ms (мгновенно)
- OCR-метод: ~500-2000ms (заметная задержка)

### Надежность:
- DOM-метод: ~100% (когда данные в DOM)
- OCR-метод: ~95-98% (зависит от качества текста)

## Альтернативные решения

Если размер расширения критичен, можно:
1. Использовать легковесный OCR (но менее точный)
2. OCR только на сервере (Python)
3. Опциональная загрузка OCR (по требованию)

## Вывод

**Рекомендация:** Добавить OCR как резервный метод, но сделать опциональным (можно отключить в настройках).

**Порядок приоритета:**
1. DOM-метод (быстро, точно) - основной
2. OCR-метод (медленнее, но надежнее) - резерв

Это даст максимальную надежность без существенного влияния на производительность в обычных случаях.

