# Логика работы приложения

## Как работает приложение

### 1. Обнаружение номеров ячеек

**ВАЖНО:** Приложение НЕ использует OCR (распознавание текста с экрана). Вместо этого используется прямое чтение данных из DOM страницы.

**Процесс работы:**

1. **Менеджер сканирует штрих-код товара сканером**
   - Сканер отправляет данные в систему Ozon/Wildberries
   - Система обрабатывает данные

2. **Система Ozon/Wildberries записывает номер ячейки в DOM страницы**
   - Номер ячейки появляется в структуре HTML страницы
   - Может быть в разных местах: input поля, текстовые элементы, атрибуты data-*
   - Примеры форматов: `122`, `122-1`, `122-2`, `A1-1`, `65-1`

3. **Наше расширение автоматически обнаруживает изменения**
   - Использует **MutationObserver** для отслеживания изменений DOM в реальном времени
   - При каждом изменении проверяет недавно добавленные/измененные элементы
   - Ищет номера ячеек по регулярным выражениям
   - Проверяет валидность найденных номеров

4. **Отправка на печать**
   - Найденный номер ячейки автоматически отправляется на сервер печати
   - Сервер формирует команды ESC/POS для принтера
   - Принтер печатает этикетку

### 2. Форматы номеров ячеек

**Поддерживаемые форматы:**

- **Один товар:** просто число, например `122`
- **Два товара:** `122-1` и `122-2`
- **Три товара:** `122-1`, `122-2`, `122-3`
- И так далее по возрастанию суффикса

**Другие форматы:**
- `65-1`, `529-13` (цифра-цифра)
- `A1-1`, `B2-3` (буква-цифра-цифра)
- `AA1-1`, `AB2-3` (двухбуквенные)
- С точкой: `A1.1`, `B2.3`
- С подчеркиванием: `A1_1`, `B2_3`
- Со слэшем: `A1/1`, `B2/3`

### 3. Технические детали обнаружения

**MutationObserver:**
```javascript
observer.observe(document.body, {
  childList: true,      // Добавление/удаление элементов
  subtree: true,        // Во всех вложенных элементах
  characterData: true,  // Изменения текста
  attributes: true      // Изменения атрибутов (value, data-*)
});
```

**Приоритетный поиск:**
1. Сначала проверяются недавно измененные элементы (быстрее)
2. Затем поиск по DOM-селекторам (классы, атрибуты)
3. Поиск по регулярным выражениям
4. Валидация найденных номеров

**Валидация:**
- Исключает ложные срабатывания (даты, IP-адреса, время)
- Проверяет, что номер ячейки еще не печатался (избежание дубликатов)
- Поддерживает простые числа в контексте специальных элементов (input, элементы с классами cell)

---

## Сравнение с аналогами

### Numberries (основной конкурент)

**Технология:** OCR (Optical Character Recognition)
- Захватывает область экрана
- Распознает текст с изображения
- Точность до 98%
- Требует выделения области вручную

**Процесс:**
1. Пользователь выделяет область экрана мышью
2. Программа захватывает скриншот области
3. OCR распознает текст
4. Находит номер ячейки
5. Отправляет на печать

**Недостатки:**
- Может ошибаться при распознавании (98% точности)
- Требует настройки области
- Медленнее (обработка изображения)
- Зависит от качества шрифта и размера текста

### Наше решение

**Технология:** Прямое чтение DOM
- Читает данные напрямую из структуры страницы
- Точность ~100% (прямой доступ к данным)
- Не требует настройки областей
- Работает мгновенно

**Процесс:**
1. Система Ozon записывает номер ячейки в DOM
2. MutationObserver фиксирует изменение
3. Находим номер ячейки в DOM (прямой доступ)
4. Отправляем на печать

**Преимущества:**
- ✅ Точность 100% (не зависит от качества изображения)
- ✅ Мгновенная работа (нет обработки изображения)
- ✅ Не требует настройки областей
- ✅ Работает автоматически после сканирования
- ✅ Бесплатно и с открытым исходным кодом

**Недостатки:**
- Требует установки расширения браузера
- Может потребоваться обновление при изменениях на сайтах маркетплейсов

---

## Полный цикл работы (пример)

### Сценарий: Приемка трех товаров от одного клиента

1. **Менеджер сканирует первый товар**
   - Сканер → Ozon → запись "122-1" в DOM
   - MutationObserver фиксирует изменение
   - Находим "122-1" → отправка на сервер → **печать "122-1"**
   - Время: ~1-2 секунды

2. **Менеджер сканирует второй товар**
   - Сканер → Ozon → запись "122-2" в DOM
   - MutationObserver фиксирует изменение
   - Находим "122-2" → отправка на сервер → **печать "122-2"**
   - Время: ~1-2 секунды

3. **Менеджер сканирует третий товар**
   - Сканер → Ozon → запись "122-3" в DOM
   - MutationObserver фиксирует изменение
   - Находим "122-3" → отправка на сервер → **печать "122-3"**
   - Время: ~1-2 секунды

**Итого:** 3 этикетки напечатаны автоматически за ~3-6 секунд без участия менеджера.

---

## Ключевые отличия от аналогов

| Характеристика | Numberries | Наше решение |
|----------------|------------|--------------|
| **Технология** | OCR (распознавание с экрана) | Прямое чтение DOM |
| **Точность** | До 98% | ~100% |
| **Скорость** | Зависит от OCR | Мгновенно |
| **Настройка** | Нужно выделить область | Не требуется |
| **Работа** | Ручной захват экрана | Автоматически после сканирования |
| **Стоимость** | 290 руб/мес | Бесплатно |

---

## Итог

**Наше решение использует прямое чтение DOM вместо OCR**, что обеспечивает:
- Максимальную точность (~100% vs 98%)
- Максимальную скорость (мгновенно vs обработка изображения)
- Полную автоматизацию (без ручных действий)

Это принципиальное отличие от аналогов и главное конкурентное преимущество.

